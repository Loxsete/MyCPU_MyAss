# Документация CPU системы

## Обзор

Эта система представляет собой эмулятор 16-битного CPU с собственным ассемблером и BIOS. Система состоит из трех основных компонентов:

- **Ассемблер** (`assembler.c`) - транслирует ассемблерный код в бинарные файлы
- **CPU** (`cpu.c`) - эмулирует 16-битный процессор с набором инструкций
- **BIOS** (`bios.c`) - предоставляет системные вызовы и управление вводом/выводом

## Архитектура CPU

### Регистры

Система имеет 7 16-битных регистров:

- `AX` (R0) - Аккумулятор
- `BX` (R1) - Базовый регистр
- `CX` (R2) - Счетчик
- `DX` (R3) - Регистр данных
- `SP` (R4) - Указатель стека
- `BP` (R5) - Базовый указатель
- `IP` (R6) - Указатель инструкций

### Флаги

- `zero_flag` - устанавливается при нулевом результате
- `carry_flag` - устанавливается при переполнении
- `sign_flag` - устанавливается для отрицательных результатов

### Память

- Память организована как массив 16-битных слов
- Адресация байтовая (адреса в байтах)
- Стек растет вниз от верхней границы памяти
- Программы загружаются с адреса 0x1000 (4096 байт)

## Набор инструкций

### Базовые инструкции

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 0 | NOP | Нет операции |
| 1 | HLT | Остановка выполнения |

### Пересылка данных

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 2 | MOV | Пересылка данных |
| 28 | MOV reg, [mem] | Загрузка из памяти |
| 29 | MOV [mem], reg | Сохранение в память |

### Арифметические операции

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 3 | ADD | Сложение |
| 4 | SUB | Вычитание |
| 5 | MUL | Умножение |
| 6 | DIV | Деление |
| 7 | MOD | Остаток от деления |
| 12 | NEG | Отрицание |

### Логические операции

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 8 | AND | Логическое И |
| 9 | OR | Логическое ИЛИ |
| 10 | XOR | Исключающее ИЛИ |
| 11 | NOT | Логическое НЕ |

### Сдвиги

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 13 | SHL | Сдвиг влево |
| 14 | SHR | Сдвиг вправо |

### Сравнение

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 15 | CMP | Сравнение |

### Стек

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 16 | PUSH | Поместить в стек |
| 17 | POP | Извлечь из стека |
| 18 | PUSHA | Сохранить все регистры |
| 19 | POPA | Восстановить все регистры |

### Управление выполнением

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 21 | JMP | Безусловный переход |
| 22 | CALL | Вызов подпрограммы |
| 23 | RET | Возврат из подпрограммы |
| 24 | JZ/JE | Переход при равенстве нулю |
| 25 | JNZ/JNE | Переход при неравенстве нулю |
| 26 | JG | Переход при больше |
| 27 | JL | Переход при меньше |

### Системные вызовы

| Опкод | Мнемоника | Описание |
|-------|-----------|----------|
| 20 | INT | Прерывание/системный вызов |

## Режимы адресации

Инструкции кодируются в следующем формате:
```
[5 бит опкод][3 бита reg1][3 бита reg2][5 бит режим]
```

Режимы:
- 0: Без операндов
- 1: Один регистр
- 2: Регистр-регистр
- 3: Регистр-непосредственное значение
- 4: Регистр-память
- 5: Только непосредственное значение
- 6: Загрузка из памяти
- 7: Сохранение в память

## BIOS - Системные вызовы

### INT 1 - Ввод с клавиатуры

**Функция 0x01 (GET_KEY)**
- Вход: AX = 0x01
- Выход: AX = код клавиши, ZF = 0 если клавиша нажата

**Функция 0x02 (PEEK_KEY)**
- Вход: AX = 0x02
- Выход: AX = код клавиши без ожидания

**Функция 0x03 (READ_LINE)**
- Вход: AX = 0x03, BX = адрес буфера
- Выход: Строка в буфере по адресу BX

### INT 2 - Вывод строки

- Вход: AX = адрес строки
- Действие: Выводит строку, завершенную нулем

### INT 3 - Функции экрана

**Функция 0x01 - Новая строка**
- Вход: AX = 0x01
- Действие: Добавляет символ новой строки к выводу

**Функция 0x02 - Очистка экрана**
- Вход: AX = 0x02
- Действие: Очищает буфер вывода

### INT 4 - Задержка

- Вход: AX = время задержки в миллисекундах
- Действие: Приостанавливает выполнение на указанное время

### INT 6 - Загрузка программы

- Вход: AX = индекс файла
- Действие: Загружает .bin файл из директории bin/

### INT 9 - Совместимость (READ_LINE)

- Действие: Читает строку по адресу 100
- Выход: AX = 100 если строка прочитана

## Ассемблер

### Синтаксис

**Метки:**
```assembly
label:
    mov ax, 10
```

**Комментарии:**
```assembly
; Это комментарий
mov ax, 10  ; Комментарий в конце строки
```

**Числа:**
```assembly
mov ax, 42      ; Десятичное
mov ax, 0x2A    ; Шестнадцатеричное
mov ax, 0b101010 ; Двоичное
```

### Директивы

**`.org адрес`** - Устанавливает начальный адрес программы
```assembly
.org 0x1000
```

**Данные:**
```assembly
msg: db "Hello World", 0    ; Байты
numbers: dw 1, 2, 3, 4      ; Слова (16 бит)
values: dd 0x12345678       ; Двойные слова (32 бита)
```

### Пример программы

```assembly
.org 0x1000

start:
    mov ax, msg      ; Загрузить адрес строки
    int 2            ; Вывести строку
    
    mov ax, 0x01     ; Функция новой строки
    int 3            ; Вызвать функцию экрана
    
    hlt              ; Остановить выполнение

msg: db "Hello, World!", 0
```

## Компиляция и запуск

1. **Компиляция ассемблера:**
```bash
gcc -o assembler assembler.c
```

2. **Ассемблирование программы:**
```bash
./assembler program.asm program.bin
```

3. **Запуск эмулятора:**
```bash
gcc -o emulator main.c cpu.c bios.c -lraylib
./emulator
```

## Ограничения

- Память: 16-битная адресация (64KB)
- Регистры: 7 регистров по 16 бит
- Стек: Фиксированный размер
- Запрещенные адреса: 0xFF00-0xFFFF (зарезервировано для BIOS/MMIO)
- Максимум файлов: определяется константой MAX_FILES
- Размер буфера ввода: 256 символов

## Расширения

Система поддерживает расширения через:
- Новые системные вызовы (INT)
- Дополнительные инструкции процессора
- Расширение BIOS функциональности

Система предназначена для образовательных целей и демонстрации основных принципов работы процессора и ассемблера.
